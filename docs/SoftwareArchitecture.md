# 软件体系架构
[toc]
## 背景
GitHub 上有很多优秀的关于天气预测的 Repository ，但都是基于本地化和网络爬虫进行的，所以我创建了这个Repository。我们的项目基于机器学习的随机森林模型对天气进行预测，并且通过Streamlit Cloud 部署到服务器端。
<!---->


当然，没有一个Repository可以满足所有人的要求，因为你的需求可能与众不同。所以我们会在未来添加更多内容。你也可以通过复刻（fork）本仓库并且创建一个拉取请求（pull request）或者创建议题（issue）来向我们提出建议。感谢所有帮助我们扩充本仓库的贡献者！


如果你对我的网站感兴趣，欢迎访问我的线上网站[🌦️Weather Now](https://weathernowpublic.streamlit.app/) 来开始。
## 架构
本项目大体上采用了分层系统风格架构。
总体分为**表示层**，**应用层**，**服务层**，**数据访问层**。
层与层之前不能直接进行互通，非相邻分层之间不可以进行数据互通，只可以进行迭代访问。
### 层的划分
```
表示层： 负责处理用户界面和用户交互。例如，网页或移动应用的前端界面。
应用层： 包含系统的业务逻辑，处理用户请求并执行相关的操作。
服务层： 提供应用层所需的特定服务，如认证或数据转换服务。
数据访问层： 负责与数据库或其他持久性存储进行交互。
```




#### 数据访问层
构成数据访问层的主要类为`GetData`。通过获取数据使得整个程序得以运转和训练。
* **GetData**：通过使用requests库的方法`requests.get(url,params,**kwargs)`对url进行数据的获取，并且进行网页数据的decode。
向上对服务层提供`url`和`headers`的接口
#### 服务层
构成服务层的主要类为`Data2CSV`和`TrainDataProcess`。通过对获取的数据进行数据清洗和CSV持久化保存，之后通过对CSV文件的分割处理为训练集和验证集
* **Data2CSV**：
  * `remove_units(data)`: 清理数据，去除非数字字符，并为缺失数据填充占位符。
  * `url_process(years, days)`: 构建用于获取天气数据的URL，基于输入的年份和天数差值计算日期范围。
  * `data2csv(years, days, filename)`:从生成的URL下载天气数据，使用XPath提取相关数据，清理并格式化后，写入到一个CSV文件中
* **TrainDataProcess**
  * `ProcessData(city_idx)`:实现数据预处理，包括清洗和分割。
服务层通过调用数据层获取数据，并且向上提供`years`、 `days` 、`city_idx` 接口
#### 应用层
构成应用层的主要类为`Model`和`Socket`。他的实现主要来自于表示层的调用，当表示层有包括但不限于更改查询城市的事件请求时，附加传入的参数对模型进行训练,并本地化为PKL文件减少网站压力。
* **Model**：
  * `GetModel(city_idx, filename="Model.pkl")`：实现模型训练、评估和保存。
* **socket**：
  * `find(city_name)`:传入的城市名称，用于在 city.csv 文件中查找。
应用层通过上层传入的参数进行模型训练，向上对表示层提供`city_name `的接口
### 表示层
表示层主要通过网站与用户进行可视化的交互，可视化的主要实现类为`VISUALIZATION`。通过用户在可视化控件进行不同的输入，将其作为参数调用下一层的服务进行反馈并保证用户交互过程中的稳定性。


1. 工作方式
每一层都有明确的职责，只能通过层次间的接口与其他层通信。例如，应用层不能直接与数据层交互，而必须通过数据访问层来实现。
这种模式有助于降低系统的耦合度，增强可测试性和可维护性。
1. 优点
模块化： 通过分离不同的关注点，可以更容易地进行开发和维护。
可扩展性： 可以在不影响其他层的情况下更新或替换某一层的实现。
可测试性： 每一层都可以单独测试，从而提高系统的整体稳定性。
1. 缺点
性能问题： 多层结构可能会带来一定的性能开销，尤其是在跨层通信时。
复杂性： 如果划分过于细致，系统结构可能变得复杂，不利于开发和理解。

## 功能
* **实时天气查询**：获取全球各城市的当前天气。
* **机器学习预测**：使用随机森林算法训练模型并拟合数据
* **天气详细信息**：显示温度、湿度、气压、风速等。
* **简洁易用**：友好的用户界面和交互体验。
  
## 测试
总体的测试我们整体分为两个部分，分别是对于网站的在线测试，和对于训练模型的评估
### 网站测试
我们按照网站测试的一般流程，分步骤对网站进行了UI测试、链接测试、搜索测试、网站响应
#### UI测试

* 各页面的风格是否统一
* 各页面的大小是否一致；同样的LOGO图片在各个页面中显示是否大小一致；
* 页面及图片是否居中显示 、各页面的title是否正确。
* 栏目名称、文章内容等处的文字是否正确，有错别字或乱码；
* 同一级别的字体、大小、颜色是否统一




#### 链接测试
* 页面是否有无法连接的内容；图片是否能正常显示，有无冗余图片，代码是否规范
* 页面点击LOGO下的一级栏目或二级栏目名称，是否可进入相应的栏目

#### 搜索测试
* 搜索是否实现
* 输入网站中存在的信息，能否正确搜索出结果
* 系统是否支持快捷键回车键，Tab
* 默认查询字段
#### 网站响应

我们使用了较为成熟的网站响应测试工具[gtmetrix](https://gtmetrix.com/)进行了响应测试
这个工具根据网站速度打分A-F，结合Yslow和PageSpeedInsights的数据，提供网站表现报告帮助用户分析网站问题并优化。
![alt text](/images/website_test.png)
* **GTmetrix Grade**：你的 GTmetrix 等级是对你的整体页面性能的评估。它既反映了您的页面为用户加载的速度，也反映了它的性能。
* **Structure**：您的结构得分是我们对 Lighthouse 和自定义 GTmetrix 审核的专有评估。它代表了您的页面是否能达到最佳性能。
* **Web Vitals**： Web Vitals 代表了一小部分核心指标，它们表明您是否为访客提供了快速和（Google 所称的）愉悦的体验。在进行更深层次的优化之前，首先关注这些有影响力的指标
* **CLS**：CLS 表示页面加载时访问者体验到的布局变化程度。要获得良好的用户体验，CLS 分数应在 0.1 或以下。
  
### 模型测试
我们对于模型的拟合程度从**MAE**的角度进行分析，除此以外，因为在线网站的特性，我们同时需要关注模型的**响应速度**。

#### MAE
平均绝对误差（MAE，Mean Absolute Error）是衡量预测模型或估计方法准确度的指标之一。它反映了预测值与真实值之间的绝对误差的平均水平。MAE 的计算公式如下：
```
MAE = (1/n) * Σ|yi - xi|
```
此外，我们对拟合数据集的天数进行超参数调优。由于天气系统的本质是混沌系统，因此对于数据集的采样天数并非越多越好，否则容易产生过拟合的情形。

_使用网格搜索优化后，我们的天数优化的结果是10天，MAE=3.6021（2024.11.14）_

#### 响应速度
Heartrate 是一个 Python 的工具库，可以实时可视化 Python 程序的执行过程。我们使用Heartrate结合time模块对模型的响应速度进行评估。
其次在随机森林模型中，我们需要适当减少决策树的数量和最大深度，来减少模型的运算量以增加运算速度

_在大多数网络环境的综合速率大致在2.6s_

## 预期成果

- [x] 添加更新日志
- [x] 使用 Radom Frost 进行模型训练
- [x] 使用Streamlit进行数据可视化
- [X] 使用Streamlit Cloud进行服务器部署
- [ ] 进一步优化可视化界面
    - [x] 增加侧边栏控件
    - [x] 增加开屏动画
    - [ ] 增加多种数据展示图样
- [ ] 优化模型超参数
